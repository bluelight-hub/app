#!/bin/bash

# Git Hook fÃ¼r Commit-Message Validation
# Basierend auf 030-commit-rules

COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

if echo "$COMMIT_MSG" | grep -q "\[skip ci\]"; then
    echo "ğŸ” Skip-CI Flag erkannt, Ã¼berspringe Validierung und Tests..."
    exit 0
fi

# Emoji-Pattern fÃ¼r erlaubte Commit-Typen
EMOJI_PATTERN="^(ğŸ’¥|âœ¨|ğŸ›|ğŸš‘|ğŸ”’|ğŸ§¹|â™»ï¸|ğŸ”§|ğŸ“¦|ğŸ“|ğŸ’„|âš¡|ğŸ—‘|ğŸ› |ğŸš€|ğŸ‰|ğŸ§ª)\([a-zA-Z0-9-]+\): .+"

# ZÃ¤hle Zeilen (ignoriere leere Zeilen am Ende)
LINE_COUNT=$(echo "$COMMIT_MSG" | sed '/^$/d' | wc -l | tr -d ' ')

echo "ğŸ” Validiere Commit-Nachricht..."
echo "ğŸ“ Anzahl Zeilen: $LINE_COUNT"

# PrÃ¼fe Grundformat
if ! echo "$COMMIT_MSG" | head -n1 | grep -qE "$EMOJI_PATTERN"; then
    echo "âŒ FEHLER: Commit-Nachricht entspricht nicht dem Format!"
    echo "ğŸ“‹ Erwartetes Format: <emoji>(<context>): <kurze Beschreibung>"
    echo "ğŸ“š Siehe .cursor/rules/030-commit-rules.mdc fÃ¼r Details"
    echo ""
    echo "ğŸ“ Erlaubte Emojis:"
    echo "   ğŸ’¥ Breaking Changes    âœ¨ Neue Features      ğŸ› Bug Fixes         ğŸš‘ Hotfixes"
    echo "   ğŸ”’ Security           ğŸ§¹ Cleanup           â™»ï¸  Refactoring       ğŸ”§ Configuration"
    echo "   ğŸ“¦ Dependencies       ğŸ“ Documentation     ğŸ’„ Styling/UI        âš¡ Performance"
    echo "   ğŸ—‘ Removal            ğŸ›  Tooling           ğŸš€ Deployment        ğŸ‰ Initial Commit"
    echo "   ğŸ§ª Tests"
    echo ""
    echo "ğŸ”§ Beispiele:"
    echo "   âœ¨(frontend): Neue BenutzeroberflÃ¤che fÃ¼r Dashboard"
    echo "   ğŸ›(backend): Korrigiere Auth-Fehler bei OAuth-Anmeldung"
    echo "   ğŸ”§(config): Aktualisiere ESLint-Konfiguration"
    exit 1
fi

# PrÃ¼fe ob Commit mehrzeilig ist (mindestens 3 Zeilen fÃ¼r substantielle Commits)
if [ "$LINE_COUNT" -lt 3 ]; then
    echo "âš ï¸  WARNUNG: Einzeilige Commit-Nachricht erkannt!"
    echo "ğŸ“‹ FÃ¼r substantielle Ã„nderungen sind mehrzeilige Commits erwÃ¼nscht:"
    echo ""
    echo "   <emoji>(<context>): <kurze Beschreibung>"
    echo "   "
    echo "   <detaillierte Beschreibung>"
    echo "   - <Stichpunkt 1>"
    echo "   - <Stichpunkt 2>"
    echo ""
    echo "ğŸ¤” Ist dies wirklich nur eine triviale Ã„nderung?"
    echo "ğŸ’¡ FÃ¼r komplexe Ã„nderungen verwende: git commit (ohne -m) oder erstelle commit-message.txt"
    echo ""
    echo "â­ï¸  Trotzdem fortfahren? (Enter=Ja, Ctrl+C=Abbruch)"
    read -r
fi

# PrÃ¼fe erste Zeile LÃ¤nge
FIRST_LINE=$(echo "$COMMIT_MSG" | head -n1)
FIRST_LINE_LENGTH=${#FIRST_LINE}

if [ "$FIRST_LINE_LENGTH" -gt 72 ]; then
    echo "âŒ FEHLER: Erste Zeile zu lang ($FIRST_LINE_LENGTH Zeichen, max. 72)"
    echo "ğŸ“ Erste Zeile: $FIRST_LINE"
    echo "ğŸ’¡ Verschiebe Details in nachfolgende Zeilen"
    exit 1
fi

echo "âœ… Commit-Nachricht ist gÃ¼ltig!"

#echo "ğŸ” FÃ¼hre Tests aus..."
#pnpm test:cov
#TEST_RESULT=$?
#
## Wenn Tests fehlschlagen, verhindere den Commit
#if [ $TEST_RESULT -ne 0 ]; then
#    echo "âŒ Tests fehlgeschlagen (Exit-Code: $TEST_RESULT), Commit wird abgebrochen"
#    exit 1
#fi
exit 0 