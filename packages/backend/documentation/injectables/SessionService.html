<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>@bluelight-hub/backend documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	   <link rel="stylesheet" href="../styles/style.css">
        <link rel="stylesheet" href="../styles/dark.css">
    </head>
    <body>
          <script>
               // Blocking script to avoid flickering dark mode
               // Dark mode toggle button
               var useDark = window.matchMedia('(prefers-color-scheme: dark)');
               var darkModeState = useDark.matches;
               var $darkModeToggleSwitchers = document.querySelectorAll('.dark-mode-switch input');
               var $darkModeToggles = document.querySelectorAll('.dark-mode-switch');
               var darkModeStateLocal = localStorage.getItem('compodoc_darkmode-state');

               function checkToggle(check) {
                    for (var i = 0; i < $darkModeToggleSwitchers.length; i++) {
                         $darkModeToggleSwitchers[i].checked = check;
                    }
               }

               function toggleDarkMode(state) {
                    if (window.localStorage) {
                         localStorage.setItem('compodoc_darkmode-state', state);
                    }

                    checkToggle(state);

                    const hasClass = document.body.classList.contains('dark');

                    if (state) {
                         for (var i = 0; i < $darkModeToggles.length; i++) {
                              $darkModeToggles[i].classList.add('dark');
                         }
                         if (!hasClass) {
                              document.body.classList.add('dark');
                         }
                    } else {
                         for (var i = 0; i < $darkModeToggles.length; i++) {
                              $darkModeToggles[i].classList.remove('dark');
                         }
                         if (hasClass) {
                              document.body.classList.remove('dark');
                         }
                    }
               }

               useDark.addEventListener('change', function (evt) {
                    toggleDarkMode(evt.matches);
               });
               if (darkModeStateLocal) {
                    darkModeState = darkModeStateLocal === 'true';
               }
               toggleDarkMode(darkModeState);
          </script>

        <div class="navbar navbar-default navbar-fixed-top d-md-none p-0">
               <div class="d-flex">
                    <a href="../" class="navbar-brand">@bluelight-hub/backend documentation</a>
                    <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
               </div>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="d-none d-md-block menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content injectable">
                   <div class="content-data">








<ol class="breadcrumb">
  <li class="breadcrumb-item">Injectables</li>
  <li class="breadcrumb-item" >SessionService</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="nav-item">
            <a href="#info" 
                class="nav-link"
                class="nav-link active"
                role="tab" id="info-tab" data-bs-toggle="tab" data-link="info">Info</a>
        </li>
        <li class="nav-item">
            <a href="#source" 
                class="nav-link"
                
                role="tab" id="source-tab" data-bs-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>src/modules/session/session.service.ts</code>
        </p>


            <p class="comment">
                <h3>Description</h3>
            </p>
            <p class="comment">
                <p>Service für die Verwaltung und Überwachung von Benutzersitzungen</p>
<p>Dieser Service bietet umfassende Funktionen für:</p>
<ul>
<li>Session-Erstellung und -Verwaltung</li>
<li>Risikobewertung und Anomalieerkennung</li>
<li>Aktivitätsverfolgung und Heartbeat-Updates</li>
<li>Statistiken und Analysen</li>
<li>Session-Revozierung und -Cleanup</li>
</ul>

            </p>



            <section data-compodoc="block-index">
    <h3 id="index">Index</h3>
    <table class="table table-sm table-bordered index-table">
        <tbody>
                <tr>
                    <td class="col-md-4">
                        <h6><b>Properties</b></h6>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <ul class="index-list">
                            <li>
                                    <span class="modifier">Private</span>
                                    <span class="modifier">Readonly</span>
                                <a href="#locationCache" >locationCache</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                    <span class="modifier">Readonly</span>
                                <a href="#logger" >logger</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                    <span class="modifier">Readonly</span>
                                <a href="#sessionCache" >sessionCache</a>
                            </li>
                        </ul>
                    </td>
                </tr>

                <tr>
                    <td class="col-md-4">
                        <h6><b>Methods</b></h6>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <ul class="index-list">
                            <li>
                                    <span class="modifier">Private</span>
                                    <span class="modifier">Async</span>
                                <a href="#assessSessionRisk" >assessSessionRisk</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                <a href="#calculateDistribution" >calculateDistribution</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                <a href="#calculateRiskScore" >calculateRiskScore</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#enhanceSession" >enhanceSession</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                    <span class="modifier">Async</span>
                                <a href="#getLocationFromIp" >getLocationFromIp</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getSessionDetails" >getSessionDetails</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getSessions" >getSessions</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getSessionStatistics" >getSessionStatistics</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                <a href="#getSuspiciousFlags" >getSuspiciousFlags</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                <a href="#isSuspiciousUserAgent" >isSuspiciousUserAgent</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                <a href="#mapSessionActivity" >mapSessionActivity</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#markInactiveSessions" >markInactiveSessions</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                <a href="#parseUserAgent" >parseUserAgent</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#revokeSession" >revokeSession</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#revokeUserSessions" >revokeUserSessions</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#trackActivity" >trackActivity</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#updateHeartbeat" >updateHeartbeat</a>
                            </li>
                        </ul>
                    </td>
                </tr>





        </tbody>
    </table>
</section>

            <section data-compodoc="block-constructor">
    <h3 id="constructor">Constructor</h3>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
<code>constructor(prisma: <a href="../injectables/PrismaService.html" target="_self">PrismaService</a>, configService: ConfigService, eventEmitter: EventEmitter2)</code>
                    </td>
                </tr>
                        <tr>
                            <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="44" class="link-to-prism">src/modules/session/session.service.ts:44</a></div>
                            </td>
                        </tr>

                <tr>
                    <td class="col-md-4">
                            <div>
                                    <b>Parameters :</b>
                                    <table class="params">
                                        <thead>
                                            <tr>
                                                <td>Name</td>
                                                    <td>Type</td>
                                                <td>Optional</td>
                                            </tr>
                                        </thead>
                                        <tbody>
                                                <tr>
                                                        <td>prisma</td>
                                                  
                                                        <td>
                                                                        <code><a href="../injectables/PrismaService.html" target="_self" >PrismaService</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>configService</td>
                                                  
                                                        <td>
                                                                    <code>ConfigService</code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>eventEmitter</td>
                                                  
                                                        <td>
                                                                    <code>EventEmitter2</code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                        </tbody>
                                    </table>
                            </div>
                    </td>
                </tr>
            </tbody>
        </table>
</section>

            <section data-compodoc="block-methods">
    
    <h3 id="methods">
        Methods
    </h3>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="assessSessionRisk"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                            <span class="modifier">Async</span>
                        <span ><b>assessSessionRisk</b></span>
                        <a href="#assessSessionRisk"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>assessSessionRisk(sessionJti: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, ipAddress: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, deviceInfo: <a href="../interfaces/DeviceInfo.html" target="_self">DeviceInfo</a>, location: <a href="../interfaces/LocationInfo.html" target="_self">LocationInfo | null</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="344"
                                    class="link-to-prism">src/modules/session/session.service.ts:344</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Bewertet Session-Risikofaktoren</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>sessionJti</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>ipAddress</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>deviceInfo</td>
                                            <td>
                                                            <code><a href="../interfaces/DeviceInfo.html" target="_self" >DeviceInfo</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>location</td>
                                            <td>
                                                            <code><a href="../interfaces/LocationInfo.html" target="_self" >LocationInfo | null</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;SessionRiskFactors&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="calculateDistribution"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                        <span ><b>calculateDistribution</b></span>
                        <a href="#calculateDistribution"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>calculateDistribution(items: any[], field: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="529"
                                    class="link-to-prism">src/modules/session/session.service.ts:529</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Berechnet Verteilung für Statistiken</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>items</td>
                                            <td>
                                                        <code>any[]</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>field</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Record&lt;string, number&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="calculateRiskScore"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                        <span ><b>calculateRiskScore</b></span>
                        <a href="#calculateRiskScore"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>calculateRiskScore(factors: <a href="../interfaces/SessionRiskFactors.html" target="_self">SessionRiskFactors</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="428"
                                    class="link-to-prism">src/modules/session/session.service.ts:428</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Berechnet den Risiko-Score basierend auf Faktoren</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>factors</td>
                                            <td>
                                                            <code><a href="../interfaces/SessionRiskFactors.html" target="_self" >SessionRiskFactors</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="enhanceSession"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>enhanceSession</b></span>
                        <a href="#enhanceSession"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>enhanceSession(sessionJti: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, ipAddress: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, userAgent: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, loginMethod: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="55"
                                    class="link-to-prism">src/modules/session/session.service.ts:55</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Erweitert eine bestehende Session mit Monitoring-Daten</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                                <td>Default value</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>sessionJti</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                            </td>

                                        </tr>
                                        <tr>
                                                <td>ipAddress</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                            </td>

                                        </tr>
                                        <tr>
                                                <td>userAgent</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                            </td>

                                        </tr>
                                        <tr>
                                                <td>loginMethod</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                                    <code>&#x27;password&#x27;</code>
                                            </td>

                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;SessionWithUser&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getLocationFromIp"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                            <span class="modifier">Async</span>
                        <span ><b>getLocationFromIp</b></span>
                        <a href="#getLocationFromIp"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getLocationFromIp(ipAddress: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="487"
                                    class="link-to-prism">src/modules/session/session.service.ts:487</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Holt Location-Informationen von IP (Mock-Implementierung)</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>ipAddress</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="../interfaces/LocationInfo.html" target="_self" >Promise&lt;LocationInfo | null&gt;</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getSessionDetails"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>getSessionDetails</b></span>
                        <a href="#getSessionDetails"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getSessionDetails(sessionId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="137"
                                    class="link-to-prism">src/modules/session/session.service.ts:137</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Holt eine spezifische Session mit Details</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>sessionId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;SessionWithDetails&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getSessions"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>getSessions</b></span>
                        <a href="#getSessions"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getSessions(filter: <a href="../classes/SessionFilterDto.html" target="_self">SessionFilterDto</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="106"
                                    class="link-to-prism">src/modules/session/session.service.ts:106</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Holt alle Sessions mit optionalen Filtern</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>filter</td>
                                            <td>
                                                            <code><a href="../classes/SessionFilterDto.html" target="_self" >SessionFilterDto</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;SessionWithUser[]&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getSessionStatistics"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>getSessionStatistics</b></span>
                        <a href="#getSessionStatistics"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getSessionStatistics(userId?: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="238"
                                    class="link-to-prism">src/modules/session/session.service.ts:238</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Berechnet Session-Statistiken</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>userId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    Yes
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="../interfaces/Session.html" target="_self" >Promise&lt;SessionStatisticsDto&gt;</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getSuspiciousFlags"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                        <span ><b>getSuspiciousFlags</b></span>
                        <a href="#getSuspiciousFlags"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getSuspiciousFlags(factors: <a href="../interfaces/SessionRiskFactors.html" target="_self">SessionRiskFactors</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="445"
                                    class="link-to-prism">src/modules/session/session.service.ts:445</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Konvertiert Risikofaktoren in Suspicious Flags</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>factors</td>
                                            <td>
                                                            <code><a href="../interfaces/SessionRiskFactors.html" target="_self" >SessionRiskFactors</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="../miscellaneous/typealiases.html#SuspiciousFlag" target="_self" >SuspiciousFlag[]</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="isSuspiciousUserAgent"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                        <span ><b>isSuspiciousUserAgent</b></span>
                        <a href="#isSuspiciousUserAgent"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>isSuspiciousUserAgent(deviceInfo: <a href="../interfaces/DeviceInfo.html" target="_self">DeviceInfo</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="510"
                                    class="link-to-prism">src/modules/session/session.service.ts:510</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Prüft ob User-Agent verdächtig ist</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>deviceInfo</td>
                                            <td>
                                                            <code><a href="../interfaces/DeviceInfo.html" target="_self" >DeviceInfo</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank" >boolean</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="mapSessionActivity"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                        <span ><b>mapSessionActivity</b></span>
                        <a href="#mapSessionActivity"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>mapSessionActivity(activity)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="543"
                                    class="link-to-prism">src/modules/session/session.service.ts:543</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Mappt SessionActivity zu DTO</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>activity</td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="../classes/SessionActivityDto.html" target="_self" >SessionActivityDto</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="markInactiveSessions"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>markInactiveSessions</b></span>
                        <a href="#markInactiveSessions"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>markInactiveSessions()</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="213"
                                    class="link-to-prism">src/modules/session/session.service.ts:213</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Markiert inaktive Sessions als offline</p>
</div>

                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;number&gt;</code>

                        </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="parseUserAgent"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                        <span ><b>parseUserAgent</b></span>
                        <a href="#parseUserAgent"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>parseUserAgent(userAgent: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="462"
                                    class="link-to-prism">src/modules/session/session.service.ts:462</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Parst User-Agent String</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>userAgent</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="../interfaces/DeviceInfo.html" target="_self" >DeviceInfo</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="revokeSession"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>revokeSession</b></span>
                        <a href="#revokeSession"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>revokeSession(sessionId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, reason: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="289"
                                    class="link-to-prism">src/modules/session/session.service.ts:289</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Revoziert eine Session</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>sessionId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>reason</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;void&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="revokeUserSessions"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>revokeUserSessions</b></span>
                        <a href="#revokeUserSessions"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>revokeUserSessions(userId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, reason: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="316"
                                    class="link-to-prism">src/modules/session/session.service.ts:316</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Revoziert alle Sessions eines Benutzers</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>userId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>reason</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;number&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="trackActivity"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>trackActivity</b></span>
                        <a href="#trackActivity"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>trackActivity(sessionId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, activity: <a href="../classes/CreateSessionActivityDto.html" target="_self">CreateSessionActivityDto</a>, ipAddress?: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="159"
                                    class="link-to-prism">src/modules/session/session.service.ts:159</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Trackt eine Session-Aktivität</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>sessionId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>activity</td>
                                            <td>
                                                            <code><a href="../classes/CreateSessionActivityDto.html" target="_self" >CreateSessionActivityDto</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>ipAddress</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    Yes
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="../interfaces/Session.html" target="_self" >Promise&lt;SessionActivity&gt;</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="updateHeartbeat"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>updateHeartbeat</b></span>
                        <a href="#updateHeartbeat"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>updateHeartbeat(sessionId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="194"
                                    class="link-to-prism">src/modules/session/session.service.ts:194</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Aktualisiert den Session-Heartbeat</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>sessionId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;void&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
</section>
            <section data-compodoc="block-properties">
    
    <h3 id="inputs">
        Properties
    </h3>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="locationCache"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                            <span class="modifier">Readonly</span>
                        <span ><b>locationCache</b></span>
                        <a href="#locationCache"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Default value : </i><code>new Map&lt;string, LocationInfo&gt;()</code>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="44" class="link-to-prism">src/modules/session/session.service.ts:44</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="logger"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                            <span class="modifier">Readonly</span>
                        <span ><b>logger</b></span>
                        <a href="#logger"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Default value : </i><code>new Logger(SessionService.name)</code>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="42" class="link-to-prism">src/modules/session/session.service.ts:42</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="sessionCache"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                            <span class="modifier">Readonly</span>
                        <span ><b>sessionCache</b></span>
                        <a href="#sessionCache"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Default value : </i><code>new Map&lt;string, SessionWithUser&gt;()</code>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="43" class="link-to-prism">src/modules/session/session.service.ts:43</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
</section>

    </div>


    <div class="tab-pane fade  tab-source-code" id="source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import { Injectable, Logger } from &#x27;@nestjs/common&#x27;;
import { ConfigService } from &#x27;@nestjs/config&#x27;;
import { EventEmitter2 } from &#x27;@nestjs/event-emitter&#x27;;
import { PrismaService } from &#x27;../../prisma/prisma.service&#x27;;
import { Prisma, SessionActivity } from &#x27;../../../prisma/generated/prisma&#x27;;
import { UAParser } from &#x27;ua-parser-js&#x27;;
import {
  DeviceInfo,
  LocationInfo,
  RISK_SCORE_THRESHOLDS,
  SESSION_EVENTS,
  SessionRiskFactors,
  SessionWithDetails,
  SessionWithUser,
  SUSPICIOUS_FLAGS,
  SuspiciousFlag,
} from &#x27;./types/session.types&#x27;;
import { SessionNotFoundException } from &#x27;./exceptions/session.exceptions&#x27;;
import {
  ActivityType,
  CreateSessionActivityDto,
  DeviceType,
  SessionActivityDto,
  SessionFilterDto,
  SessionStatisticsDto,
} from &#x27;./dto/session.dto&#x27;;

/**
 * Service für die Verwaltung und Überwachung von Benutzersitzungen
 *
 * Dieser Service bietet umfassende Funktionen für:
 * - Session-Erstellung und -Verwaltung
 * - Risikobewertung und Anomalieerkennung
 * - Aktivitätsverfolgung und Heartbeat-Updates
 * - Statistiken und Analysen
 * - Session-Revozierung und -Cleanup
 *
 * @class SessionService
 */
@Injectable()
export class SessionService {
  private readonly logger &#x3D; new Logger(SessionService.name);
  private readonly sessionCache &#x3D; new Map&lt;string, SessionWithUser&gt;();
  private readonly locationCache &#x3D; new Map&lt;string, LocationInfo&gt;();

  constructor(
    private readonly prisma: PrismaService,
    private readonly configService: ConfigService,
    private readonly eventEmitter: EventEmitter2,
  ) {}

  /**
   * Erweitert eine bestehende Session mit Monitoring-Daten
   */
  async enhanceSession(
    sessionJti: string,
    ipAddress: string,
    userAgent: string,
    loginMethod &#x3D; &#x27;password&#x27;,
  ): Promise&lt;SessionWithUser&gt; {
    const deviceInfo &#x3D; this.parseUserAgent(userAgent);
    const location &#x3D; await this.getLocationFromIp(ipAddress);
    const riskFactors &#x3D; await this.assessSessionRisk(sessionJti, ipAddress, deviceInfo, location);
    const riskScore &#x3D; this.calculateRiskScore(riskFactors);
    const suspiciousFlags &#x3D; this.getSuspiciousFlags(riskFactors);

    const session &#x3D; await this.prisma.session.update({
      where: { jti: sessionJti },
      data: {
        location: location ? &#x60;${location.city}, ${location.country}&#x60; : null,
        deviceType: deviceInfo.type as DeviceType,
        browser: deviceInfo.browser,
        browserVersion: deviceInfo.browserVersion,
        os: deviceInfo.os,
        osVersion: deviceInfo.osVersion,
        loginMethod,
        riskScore,
        suspiciousFlags,
        lastHeartbeat: new Date(),
      },
      include: { user: true },
    });

    // Cache session
    this.sessionCache.set(session.id, session);

    // Emit event
    this.eventEmitter.emit(SESSION_EVENTS.SESSION_CREATED, session);

    // Log high-risk sessions
    if (riskScore &gt;&#x3D; RISK_SCORE_THRESHOLDS.HIGH) {
      this.logger.warn(&#x60;High risk session detected: ${session.id} (score: ${riskScore})&#x60;);
      this.eventEmitter.emit(SESSION_EVENTS.SESSION_RISK_DETECTED, {
        session,
        riskScore,
        factors: suspiciousFlags,
      });
    }

    return session;
  }

  /**
   * Holt alle Sessions mit optionalen Filtern
   */
  async getSessions(filter: SessionFilterDto): Promise&lt;SessionWithUser[]&gt; {
    const where: Prisma.SessionWhereInput &#x3D; {};

    if (filter.userId) where.userId &#x3D; filter.userId;
    if (filter.isOnline !&#x3D;&#x3D; undefined) where.isOnline &#x3D; filter.isOnline;
    if (filter.isRevoked !&#x3D;&#x3D; undefined) where.isRevoked &#x3D; filter.isRevoked;
    if (filter.minRiskScore !&#x3D;&#x3D; undefined) where.riskScore &#x3D; { gte: filter.minRiskScore };
    if (filter.maxRiskScore !&#x3D;&#x3D; undefined) {
      where.riskScore &#x3D; { ...(where.riskScore as any), lte: filter.maxRiskScore };
    }
    if (filter.startDate || filter.endDate) {
      where.createdAt &#x3D; {};
      if (filter.startDate) where.createdAt.gte &#x3D; filter.startDate;
      if (filter.endDate) where.createdAt.lte &#x3D; filter.endDate;
    }
    if (filter.deviceType) where.deviceType &#x3D; filter.deviceType;
    if (filter.location) where.location &#x3D; { contains: filter.location };
    if (filter.suspiciousFlags?.length) {
      where.suspiciousFlags &#x3D; { hasSome: filter.suspiciousFlags };
    }

    return this.prisma.session.findMany({
      where,
      include: { user: true },
      orderBy: { lastActivityAt: &#x27;desc&#x27; },
    });
  }

  /**
   * Holt eine spezifische Session mit Details
   */
  async getSessionDetails(sessionId: string): Promise&lt;SessionWithDetails&gt; {
    const session &#x3D; await this.prisma.session.findUnique({
      where: { id: sessionId },
      include: {
        user: true,
        activities: {
          orderBy: { timestamp: &#x27;desc&#x27; },
          take: 100,
        },
      },
    });

    if (!session) {
      throw new SessionNotFoundException(sessionId);
    }

    return session;
  }

  /**
   * Trackt eine Session-Aktivität
   */
  async trackActivity(
    sessionId: string,
    activity: CreateSessionActivityDto,
    ipAddress?: string,
  ): Promise&lt;SessionActivity&gt; {
    // Update session activity
    await this.prisma.session.update({
      where: { id: sessionId },
      data: {
        lastActivityAt: new Date(),
        activityCount: { increment: 1 },
      },
    });

    // Create activity record
    const sessionActivity &#x3D; await this.prisma.sessionActivity.create({
      data: {
        sessionId,
        ...activity,
        ipAddress,
      },
    });

    // Emit activity event
    this.eventEmitter.emit(SESSION_EVENTS.SESSION_ACTIVITY, {
      sessionId,
      activity: sessionActivity,
    });

    return sessionActivity;
  }

  /**
   * Aktualisiert den Session-Heartbeat
   */
  async updateHeartbeat(sessionId: string): Promise&lt;void&gt; {
    const session &#x3D; await this.prisma.session.update({
      where: { id: sessionId },
      data: {
        lastHeartbeat: new Date(),
        isOnline: true,
      },
      include: { user: true },
    });

    // Update cache
    this.sessionCache.set(session.id, session);

    this.eventEmitter.emit(SESSION_EVENTS.SESSION_HEARTBEAT, session);
  }

  /**
   * Markiert inaktive Sessions als offline
   */
  async markInactiveSessions(): Promise&lt;number&gt; {
    const heartbeatTimeout &#x3D; this.configService.get&lt;number&gt;(&#x27;SESSION_HEARTBEAT_TIMEOUT&#x27;, 60000); // 1 minute
    const threshold &#x3D; new Date(Date.now() - heartbeatTimeout);

    const result &#x3D; await this.prisma.session.updateMany({
      where: {
        isOnline: true,
        lastHeartbeat: { lt: threshold },
        isRevoked: false,
      },
      data: {
        isOnline: false,
      },
    });

    if (result.count &gt; 0) {
      this.logger.log(&#x60;Marked ${result.count} sessions as offline&#x60;);
    }

    return result.count;
  }

  /**
   * Berechnet Session-Statistiken
   */
  async getSessionStatistics(userId?: string): Promise&lt;SessionStatisticsDto&gt; {
    const where: Prisma.SessionWhereInput &#x3D; userId ? { userId } : {};

    const [
      totalSessions,
      activeSessions,
      revokedSessions,
      highRiskSessions,
      sessions,
      recentActivities,
    ] &#x3D; await Promise.all([
      this.prisma.session.count({ where }),
      this.prisma.session.count({ where: { ...where, isOnline: true, isRevoked: false } }),
      this.prisma.session.count({ where: { ...where, isRevoked: true } }),
      this.prisma.session.count({
        where: { ...where, riskScore: { gte: RISK_SCORE_THRESHOLDS.HIGH } },
      }),
      this.prisma.session.findMany({
        where,
        select: { deviceType: true, location: true, browser: true, os: true },
      }),
      this.prisma.sessionActivity.findMany({
        where: userId ? { session: { userId } } : {},
        orderBy: { timestamp: &#x27;desc&#x27; },
        take: 20,
        include: { session: { include: { user: true } } },
      }),
    ]);

    // Calculate distributions
    const deviceTypeDistribution &#x3D; this.calculateDistribution(sessions, &#x27;deviceType&#x27;);
    const locationDistribution &#x3D; this.calculateDistribution(sessions, &#x27;location&#x27;);
    const browserDistribution &#x3D; this.calculateDistribution(sessions, &#x27;browser&#x27;);
    const osDistribution &#x3D; this.calculateDistribution(sessions, &#x27;os&#x27;);

    return {
      totalSessions,
      activeSessions,
      revokedSessions,
      highRiskSessions,
      deviceTypeDistribution,
      locationDistribution,
      browserDistribution,
      osDistribution,
      recentActivities: recentActivities.map(this.mapSessionActivity),
    };
  }

  /**
   * Revoziert eine Session
   */
  async revokeSession(sessionId: string, reason: string): Promise&lt;void&gt; {
    const session &#x3D; await this.prisma.session.update({
      where: { id: sessionId },
      data: {
        isRevoked: true,
        revokedAt: new Date(),
        revokedReason: reason,
        isOnline: false,
      },
      include: { user: true },
    });

    // Remove from cache
    this.sessionCache.delete(sessionId);

    // Emit termination event
    this.eventEmitter.emit(SESSION_EVENTS.SESSION_TERMINATED, {
      session,
      reason,
    });

    this.logger.log(&#x60;Session ${sessionId} revoked: ${reason}&#x60;);
  }

  /**
   * Revoziert alle Sessions eines Benutzers
   */
  async revokeUserSessions(userId: string, reason: string): Promise&lt;number&gt; {
    const result &#x3D; await this.prisma.session.updateMany({
      where: {
        userId,
        isRevoked: false,
      },
      data: {
        isRevoked: true,
        revokedAt: new Date(),
        revokedReason: reason,
        isOnline: false,
      },
    });

    // Clear user sessions from cache
    for (const [id, session] of this.sessionCache.entries()) {
      if (session.user.id &#x3D;&#x3D;&#x3D; userId) {
        this.sessionCache.delete(id);
      }
    }

    this.logger.log(&#x60;Revoked ${result.count} sessions for user ${userId}: ${reason}&#x60;);
    return result.count;
  }

  /**
   * Bewertet Session-Risikofaktoren
   */
  private async assessSessionRisk(
    sessionJti: string,
    ipAddress: string,
    deviceInfo: DeviceInfo,
    location: LocationInfo | null,
  ): Promise&lt;SessionRiskFactors&gt; {
    const session &#x3D; await this.prisma.session.findUnique({
      where: { jti: sessionJti },
      include: { user: true },
    });

    if (!session) {
      throw new SessionNotFoundException(sessionJti);
    }

    // Get user&#x27;s session history
    const userSessions &#x3D; await this.prisma.session.findMany({
      where: {
        userId: session.userId,
        jti: { not: sessionJti },
      },
      orderBy: { createdAt: &#x27;desc&#x27; },
      take: 10,
    });

    const factors: SessionRiskFactors &#x3D; {
      newLocation: false,
      newDevice: false,
      unusualTime: false,
      rapidLocationChange: false,
      suspiciousUserAgent: false,
      highFailedLoginCount: false,
      concurrentSessionLimit: false,
    };

    // Check for new location
    if (location &amp;&amp; userSessions.length &gt; 0) {
      const knownLocations &#x3D; userSessions.map((s) &#x3D;&gt; s.location).filter(Boolean);
      factors.newLocation &#x3D; !knownLocations.includes(&#x60;${location.city}, ${location.country}&#x60;);
    }

    // Check for new device
    const deviceSignature &#x3D; &#x60;${deviceInfo.type}-${deviceInfo.browser}-${deviceInfo.os}&#x60;;
    const knownDevices &#x3D; userSessions
      .map((s) &#x3D;&gt; &#x60;${s.deviceType}-${s.browser}-${s.os}&#x60;)
      .filter(Boolean);
    factors.newDevice &#x3D; !knownDevices.includes(deviceSignature);

    // Check for unusual login time
    const hour &#x3D; new Date().getHours();
    factors.unusualTime &#x3D; hour &lt; 6 || hour &gt; 23;

    // Check for rapid location change
    if (location &amp;&amp; userSessions.length &gt; 0) {
      const lastSession &#x3D; userSessions[0];
      if (lastSession.location &amp;&amp; lastSession.lastActivityAt) {
        const timeDiff &#x3D; Date.now() - lastSession.lastActivityAt.getTime();
        const locationChanged &#x3D; lastSession.location !&#x3D;&#x3D; &#x60;${location.city}, ${location.country}&#x60;;
        factors.rapidLocationChange &#x3D; locationChanged &amp;&amp; timeDiff &lt; 3600000; // 1 hour
      }
    }

    // Check for suspicious user agent
    factors.suspiciousUserAgent &#x3D; this.isSuspiciousUserAgent(deviceInfo);

    // Check failed login count
    factors.highFailedLoginCount &#x3D; session.user.failedLoginCount &gt; 3;

    // Check concurrent session limit
    const activeSessions &#x3D; await this.prisma.session.count({
      where: {
        userId: session.userId,
        isRevoked: false,
        expiresAt: { gt: new Date() },
      },
    });
    factors.concurrentSessionLimit &#x3D; activeSessions &gt; 5;

    return factors;
  }

  /**
   * Berechnet den Risiko-Score basierend auf Faktoren
   */
  private calculateRiskScore(factors: SessionRiskFactors): number {
    let score &#x3D; 0;

    if (factors.newLocation) score +&#x3D; 20;
    if (factors.newDevice) score +&#x3D; 15;
    if (factors.unusualTime) score +&#x3D; 10;
    if (factors.rapidLocationChange) score +&#x3D; 30;
    if (factors.suspiciousUserAgent) score +&#x3D; 25;
    if (factors.highFailedLoginCount) score +&#x3D; 20;
    if (factors.concurrentSessionLimit) score +&#x3D; 10;

    return Math.min(score, 100);
  }

  /**
   * Konvertiert Risikofaktoren in Suspicious Flags
   */
  private getSuspiciousFlags(factors: SessionRiskFactors): SuspiciousFlag[] {
    const flags: SuspiciousFlag[] &#x3D; [];

    if (factors.newLocation) flags.push(SUSPICIOUS_FLAGS.NEW_LOCATION);
    if (factors.newDevice) flags.push(SUSPICIOUS_FLAGS.NEW_DEVICE);
    if (factors.unusualTime) flags.push(SUSPICIOUS_FLAGS.UNUSUAL_TIME);
    if (factors.rapidLocationChange) flags.push(SUSPICIOUS_FLAGS.RAPID_LOCATION_CHANGE);
    if (factors.suspiciousUserAgent) flags.push(SUSPICIOUS_FLAGS.SUSPICIOUS_USER_AGENT);
    if (factors.highFailedLoginCount) flags.push(SUSPICIOUS_FLAGS.HIGH_FAILED_LOGIN_COUNT);
    if (factors.concurrentSessionLimit) flags.push(SUSPICIOUS_FLAGS.CONCURRENT_SESSION_LIMIT);

    return flags;
  }

  /**
   * Parst User-Agent String
   */
  private parseUserAgent(userAgent: string): DeviceInfo {
    const parser &#x3D; new UAParser(userAgent);
    const result &#x3D; parser.getResult();

    let deviceType: string &#x3D; DeviceType.UNKNOWN;
    if (result.device.type) {
      deviceType &#x3D; result.device.type.toLowerCase();
    } else if (result.os.name?.includes(&#x27;Android&#x27;) || result.os.name?.includes(&#x27;iOS&#x27;)) {
      deviceType &#x3D; DeviceType.MOBILE;
    } else {
      deviceType &#x3D; DeviceType.DESKTOP;
    }

    return {
      type: deviceType,
      browser: result.browser.name || &#x27;Unknown&#x27;,
      browserVersion: result.browser.version || &#x27;Unknown&#x27;,
      os: result.os.name || &#x27;Unknown&#x27;,
      osVersion: result.os.version || &#x27;Unknown&#x27;,
    };
  }

  /**
   * Holt Location-Informationen von IP (Mock-Implementierung)
   */
  private async getLocationFromIp(ipAddress: string): Promise&lt;LocationInfo | null&gt; {
    // Check cache first
    if (this.locationCache.has(ipAddress)) {
      return this.locationCache.get(ipAddress)!;
    }

    // Mock implementation - in production, use a real IP geolocation service
    const mockLocations: LocationInfo[] &#x3D; [
      { city: &#x27;Berlin&#x27;, country: &#x27;Germany&#x27;, region: &#x27;Berlin&#x27;, timezone: &#x27;Europe/Berlin&#x27; },
      { city: &#x27;Munich&#x27;, country: &#x27;Germany&#x27;, region: &#x27;Bavaria&#x27;, timezone: &#x27;Europe/Berlin&#x27; },
      { city: &#x27;Hamburg&#x27;, country: &#x27;Germany&#x27;, region: &#x27;Hamburg&#x27;, timezone: &#x27;Europe/Berlin&#x27; },
      { city: &#x27;Frankfurt&#x27;, country: &#x27;Germany&#x27;, region: &#x27;Hesse&#x27;, timezone: &#x27;Europe/Berlin&#x27; },
    ];

    const location &#x3D; mockLocations[Math.floor(Math.random() * mockLocations.length)];
    this.locationCache.set(ipAddress, location);

    return location;
  }

  /**
   * Prüft ob User-Agent verdächtig ist
   */
  private isSuspiciousUserAgent(deviceInfo: DeviceInfo): boolean {
    const suspiciousPatterns &#x3D; [
      &#x27;bot&#x27;,
      &#x27;crawler&#x27;,
      &#x27;spider&#x27;,
      &#x27;scraper&#x27;,
      &#x27;curl&#x27;,
      &#x27;wget&#x27;,
      &#x27;python&#x27;,
      &#x27;java&#x27;,
    ];

    const userAgentLower &#x3D; &#x60;${deviceInfo.browser} ${deviceInfo.os}&#x60;.toLowerCase();
    return suspiciousPatterns.some((pattern) &#x3D;&gt; userAgentLower.includes(pattern));
  }

  /**
   * Berechnet Verteilung für Statistiken
   */
  private calculateDistribution(items: any[], field: string): Record&lt;string, number&gt; {
    const distribution: Record&lt;string, number&gt; &#x3D; {};

    for (const item of items) {
      const value &#x3D; item[field] || &#x27;Unknown&#x27;;
      distribution[value] &#x3D; (distribution[value] || 0) + 1;
    }

    return distribution;
  }

  /**
   * Mappt SessionActivity zu DTO
   */
  private mapSessionActivity(
    activity: SessionActivity &amp; { session: SessionWithUser },
  ): SessionActivityDto {
    return {
      id: activity.id,
      sessionId: activity.sessionId,
      timestamp: activity.timestamp,
      activityType: activity.activityType as ActivityType,
      resource: activity.resource,
      method: activity.method,
      statusCode: activity.statusCode,
      duration: activity.duration,
      ipAddress: activity.ipAddress,
      metadata: activity.metadata as Record&lt;string, any&gt;,
    };
  }
}
</code></pre>
    </div>

</div>













                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

          <label class="dark-mode-switch">
               <input type="checkbox">
               <span class="slider">
                    <svg class="slider-icon" viewBox="0 0 24 24" fill="none" height="20" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" width="20" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
                    </svg>
               </span>
          </label>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'injectable';
            var COMPODOC_CURRENT_PAGE_URL = 'SessionService.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script>
               $darkModeToggleSwitchers = document.querySelectorAll('.dark-mode-switch input');
               checkToggle(darkModeState);
               if ($darkModeToggleSwitchers.length > 0) {
                    for (var i = 0; i < $darkModeToggleSwitchers.length; i++) {
                         $darkModeToggleSwitchers[i].addEventListener('change', function (event) {
                              darkModeState = !darkModeState;
                              toggleDarkMode(darkModeState);
                         });
                    }
               }
          </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>

       <script src="../js/menu-wc.js" defer></script>
       <script nomodule src="../js/menu-wc_es5.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
